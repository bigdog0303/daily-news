<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<title>High-impact USD — Events</title>
<meta name="theme-color" content="#0c0c0e" />
<meta name="apple-mobile-web-app-capable" content="yes" />
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
<style>
html,body{margin:0;padding:0;height:100%;background:#0c0c0e;color-scheme:dark;-webkit-font-smoothing:antialiased;-webkit-text-size-adjust:100%}
:root{--bg:#0c0c0e;--text:#e9e9ee;--muted:#9fa0a8;--panel:#121316;--panel2:#17181c;--ring:#2a2b31;--badge:#1f2025;--accent:#ffd84a;--accent-ink:#201b07;--accent-ring:#5a4b13;--high:#e44;}
body{font-family:ui-sans-serif,system-ui,-apple-system,"Segoe UI",Roboto,Arial;background:var(--bg);color:var(--text);overflow-x:hidden}
header.top{padding:calc(8px + env(safe-area-inset-top,0)) 16px 10px;border-bottom:1px solid var(--ring);background:var(--bg)}
h1{margin:0 0 2px;font-size:28px;letter-spacing:.2px;font-weight:800;display:flex;gap:10px;align-items:center;flex-wrap:wrap}
.small{color:var(--muted);font-size:12px}
.tabs{display:flex;gap:10px;margin:10px 0}
.tab{padding:10px 18px;border-radius:999px;border:1px solid var(--ring);background:var(--panel2);color:#e1e1e6;cursor:pointer;font-weight:700}
.tab.active{background:#23242a;border-color:#3a3b42}
main{max-width:980px;margin:0 auto;padding:14px 12px 40px}
.note{display:flex;align-items:center;justify-content:center;min-height:48px;margin:14px 0 12px;padding:10px 14px;border-radius:14px;background:var(--panel2);border:1px solid var(--ring);color:#c9cad1;font-weight:600}
ul{list-style:none;margin:0;padding:0}
.footer{text-align:center;color:var(--muted);font-size:12px;margin-top:22px}

/* calendar */
#cal-wrap{display:none}
.cal-head{display:flex;align-items:center;justify-content:center;margin:10px 0 6px;font-weight:800;font-size:18px}
.cal-dow{display:grid;grid-template-columns:repeat(7,1fr);gap:8px;margin:4px 0 8px}
.cal-dow div{text-align:center;color:var(--muted);font-size:12px}
.cal-grid{display:grid;grid-template-columns:repeat(7,1fr);gap:8px}
.cal-cell{position:relative;border:1px solid var(--ring);background:var(--panel2);border-radius:12px;aspect-ratio:1/1}
.cal-cell.empty{opacity:.3}
.cal-cell.today{outline:1px solid var(--accent-ring)}
.cal-date{position:absolute;top:6px;right:8px;font-size:12px;color:#bbb}
.cal-marker-row{position:absolute;left:0;right:0;bottom:10px;display:flex;justify-content:center;gap:6px;flex-wrap:wrap;padding:0 6px}
.dot{width:8px;height:8px;border-radius:999px;background:var(--high);border:1px solid #6b2e2e}

/* bottom sheet */
.sheet{position:fixed;left:0;right:0;bottom:-100%;background:var(--panel2);border-top:1px solid var(--ring);border-radius:14px 14px 0 0;box-shadow:0 -10px 30px rgba(0,0,0,.4);transition:bottom .25s ease;max-height:70vh;overflow:auto;padding:14px}
.sheet.open{bottom:0}
.sheet h3{margin:4px 0 10px;font-size:18px}
.sheet .event{border:1px solid var(--ring);background:#16171b;border-radius:12px;padding:10px;margin:8px 0}
.sheet .t{font-weight:800;margin:0 0 4px}
.sheet .w{color:var(--muted);font-size:13px}
.sheet .close{position:sticky;top:-4px;float:right;border:1px solid var(--ring);background:#1f2025;color:#ddd;border-radius:999px;padding:6px 10px;cursor:pointer}
</style>
</head>

<body>
<header class="top">
  <div class="small" id="now"></div>
  <h1>High-impact USD events</h1>
  <div class="tabs">
    <div id="tabList" class="tab active">This Week</div>
    <div id="tabCal" class="tab">Full Month</div>
  </div>
  <div class="small" id="updated"></div>
</header>

<main>
  <div class="note" id="note">Loading…</div>

  <!-- calendar -->
  <section id="cal-wrap">
    <div class="cal-head" id="cal-month"></div>
    <div class="cal-dow"><div>Mon</div><div>Tue</div><div>Wed</div><div>Thu</div><div>Fri</div><div>Sat</div><div>Sun</div></div>
    <div class="cal-grid" id="cal-grid"></div>
    <div class="footer">Tap a day to see events</div>
  </section>

  <!-- list -->
  <ul id="list"></ul>
  <div class="footer">Data via ForexFactory</div>
</main>

<!-- sheet -->
<div id="sheet" class="sheet" aria-hidden="true">
  <button class="close" id="sheetClose">Close</button>
  <h3 id="sheetTitle">Events</h3>
  <div id="sheetBody"></div>
</div>

<script>
const WORKER_LIST = "https://green-haze-8240.mikaelalexiou.workers.dev";
const WORKER_CAL  = "https://holy-sun-97e7.mikaelalexiou.workers.dev";

function md(dt){return dt.toLocaleDateString([], {month:'short', day:'2-digit'})}
function hhmm(dt){return new Intl.DateTimeFormat([], {hour:'2-digit', minute:'2-digit'}).format(dt)}
function monthLabel(y,m){return new Date(y,m-1,1).toLocaleDateString([], {month:'long', year:'numeric'})}

document.getElementById('now').textContent = hhmm(new Date());

// ------------- WEEKLY -------------
async function loadList(){
  document.getElementById('list').style.display='';
  document.getElementById('cal-wrap').style.display='none';
  document.getElementById('note').textContent='Loading…';
  try{
    const r=await fetch(WORKER_LIST,{cache:'no-store'});
    const j=await r.json();
    if(j.items?.length){
      const list=document.getElementById('list');
      list.innerHTML='';
      for(const e of j.items){
        const li=document.createElement('li');
        const dt=new Date(e.datetime);
        li.textContent=`${md(dt)} ${hhmm(dt)} — ${e.title}`;
        list.appendChild(li);
      }
      document.getElementById('note').textContent=`Showing ${j.items.length} events.`;
    }else document.getElementById('note').textContent="No data.";
  }catch(e){document.getElementById('note').textContent="Failed to load."}
}

// ------------- CALENDAR -------------
function startOfMonth(y,m){return new Date(y,m-1,1)}
function endOfMonth(y,m){return new Date(y,m,0)}
function mondayIndex(d){return (d.getDay()+6)%7}
function groupByDay(items){const map={};for(const e of items){const d=new Date(e.datetime||"");if(isNaN(d))continue;const key=d.toISOString().slice(0,10);(map[key]??=[]).push(e);}return map;}

function renderCalendar(items,y,m){
  const grid=document.getElementById('cal-grid');grid.innerHTML='';
  document.getElementById('cal-month').textContent=monthLabel(y,m);
  const first=startOfMonth(y,m), last=endOfMonth(y,m), offset=mondayIndex(first);
  const byDay=groupByDay(items);
  const todayISO=new Date().toISOString().slice(0,10);
  for(let i=0;i<offset;i++){const c=document.createElement('div');c.className='cal-cell empty';grid.appendChild(c);}
  for(let d=1;d<=last.getDate();d++){
    const dayISO=`${y}-${String(m).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
    const cell=document.createElement('div');cell.className='cal-cell';
    if(dayISO===todayISO)cell.classList.add('today');
    const date=document.createElement('div');date.className='cal-date';date.textContent=d;cell.appendChild(date);
    const row=document.createElement('div');row.className='cal-marker-row';
    const evs=byDay[dayISO]||[];const dots=Math.min(evs.length,5);
    for(let i=0;i<dots;i++){const dot=document.createElement('div');dot.className='dot';row.appendChild(dot);}
    cell.appendChild(row);
    cell.onclick=()=>openSheet(dayISO,evs);
    grid.appendChild(cell);
  }
  document.getElementById('note').textContent='Tap a day to see events.';
  document.getElementById('updated').textContent='Updated: '+new Date().toLocaleString();
}

async function loadCalendar(){
  document.getElementById('list').style.display='none';
  document.getElementById('cal-wrap').style.display='block';
  document.getElementById('note').textContent='Loading calendar…';
  const ym=new Date().toISOString().slice(0,7);
  try{
    const r=await fetch(`${WORKER_CAL}/?month=${ym}`);const j=await r.json();
    if(j.items?.length){const y=+ym.slice(0,4),m=+ym.slice(5);renderCalendar(j.items,y,m);}
    else document.getElementById('note').textContent='No monthly events found.';
  }catch(e){document.getElementById('note').textContent='Calendar fetch failed.';}
}

// ------------- BOTTOM SHEET -------------
const sheet=document.getElementById('sheet');
const sheetBody=document.getElementById('sheetBody');
document.getElementById('sheetClose').onclick=()=>{sheet.classList.remove('open')};
function openSheet(dayISO,evs){
  const title=document.getElementById('sheetTitle');
  title.textContent=new Date(dayISO).toLocaleDateString([], {weekday:'long', month:'long', day:'numeric'});
  sheetBody.innerHTML='';
  if(!evs.length){sheetBody.innerHTML='<p>No events.</p>';}
  else{
    evs.sort((a,b)=>new Date(a.datetime)-new Date(b.datetime));
    for(const e of evs){
      const dt=new Date(e.datetime);
      const div=document.createElement('div');div.className='event';
      div.innerHTML=`<div class='t'>${e.title}</div><div class='w'>${hhmm(dt)} · Impact: High</div>`;
      sheetBody.appendChild(div);
    }
  }
  sheet.classList.add('open');
}

// ------------- TABS -------------
const tabList=document.getElementById('tabList');
const tabCal=document.getElementById('tabCal');
tabList.onclick=()=>{tabList.classList.add('active');tabCal.classList.remove('active');loadList();}
tabCal.onclick=()=>{tabCal.classList.add('active');tabList.classList.remove('active');loadCalendar();}

// start
loadList();
</script>
</body>
</html>
