<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>High-impact USD events for this week.</title>
<style>
  :root{
    --bg:#0b0f14; --text:#e7edf3; --muted:#a6b3c3; --card:#121821;
    --border:#2b3340; --hi:#ef4444; --ok:#60a5fa; --chip:#1f2937;
  }
  *{box-sizing:border-box}
  body{margin:0;background:var(--bg);color:var(--text);font:16px/1.4 ui-sans-serif,system-ui,Segoe UI,Roboto,Inter}
  .wrap{max-width:680px;margin:0 auto;padding:18px}
  h1{font-size:36px;line-height:1.1;margin:12px 0 8px;font-weight:800;letter-spacing:-.02em}
  .sub{color:var(--muted);margin-bottom:16px}
  .row{display:flex;align-items:center;gap:10px;flex-wrap:wrap}
  .chip{background:var(--chip);color:#c7d2e0;border:1px solid var(--border);padding:8px 12px;border-radius:999px;font-weight:700;letter-spacing:.02em}
  .gauge{flex:1;min-width:160px;height:14px;border-radius:999px;background:#0d1218;border:1px solid var(--border);overflow:hidden;position:relative}
  .gauge > span{position:absolute;left:0;top:0;bottom:0;background:linear-gradient(90deg,#64748b,#ef4444);width:40%}
  .pct{min-width:64px;text-align:right;font-weight:800;color:#fda4af}
  .updated{color:var(--muted);font-size:13px;margin-top:6px}

  .note{margin:14px 0 8px;padding:14px;border:1px solid var(--border);border-radius:14px;background:#0e141b;color:#cfd8e4}

  .card{background:var(--card);border:1px solid var(--border);border-radius:18px;padding:18px;margin:12px 0;box-shadow:0 10px 30px rgba(0,0,0,.25)}
  .title{font-size:28px;font-weight:800;letter-spacing:-.01em;margin:0 0 14px}
  .badgeRow{display:flex;gap:10px;margin-bottom:12px;flex-wrap:wrap}
  .badge{display:inline-flex;align-items:center;gap:8px;background:#0e141b;border:1px solid var(--border);padding:8px 12px;border-radius:999px}
  .dot{width:9px;height:9px;border-radius:999px;background:#ef4444;box-shadow:0 0 8px rgba(239,68,68,.6)}
  .kv{color:#cdd7e6;margin:6px 0}
  .dim{color:var(--muted)}
  .hi{color:#ef4444}
  .sr{position:absolute;left:-9999px}
</style>
</head>
<body>
  <div class="wrap">
    <div class="sub" id="time">06:32 AM</div>
    <h1>High-impact USD events<br/>for this week.</h1>

    <div class="row" style="margin:8px 0 6px">
      <div class="chip">US30</div>
      <div class="gauge"><span id="gfill" style="width:35%"></span></div>
      <div class="pct" id="pct">-0.84%</div>
    </div>
    <div class="updated" id="upd">Updated: â€”</div>

    <div id="todayNote" class="note">Showing 0 high-impact USD events today (highlighted). (seed)</div>

    <div id="list"></div>
  </div>

<script>
/* ------- CONFIG ------- */
const SEED_SENTIMENT = -0.84;     // matches your screenshot
const IMPACT_FILTER = 'High';     // High-impact only
const CURRENCY = 'USD';           // USD only
const FEEDS = [
  'https://cdn-nfs.faireconomy.media/ff_calendar_thisweek.json',
  'https://cdn-nfs.faireconomy.media/ff_calendar_nextweek.json'
];

/* ------- UTIL ------- */
const fmtTime = d => d.toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'});
const fmtDate = d => d.toLocaleString([], {month:'short', day:'2-digit'});
const startOfDayUTC = d => new Date(Date.UTC(d.getUTCFullYear(), d.getUTCMonth(), d.getUTCDate()));

/* Robust timestamp inference */
function inferISO(r){
  let ms=null;
  if (typeof r.timestamp==='number') ms=r.timestamp*(r.timestamp<2e10?1000:1);
  else if (typeof r.unix==='number') ms=r.unix*(r.unix<2e10?1000:1);
  if (ms) return new Date(ms).toISOString();
  const d=(r.date||r.day||r.datetime||'').toString();
  const time=(r.time||r.hour||'00:00').toString();
  const iso=new Date(`${d} ${time} UTC`);
  return !Number.isNaN(iso.getTime())?iso.toISOString():new Date().toISOString();
}
function normalize(raw){
  return (raw||[]).map(r=>{
    const t=inferISO(r);
    const impactRaw=(r.impact||r.impact_text||r.impact_label||'').toString().toLowerCase();
    const impactLevel=/high|red|3/.test(impactRaw)?3:/medium|yellow|2/.test(impactRaw)?2:1;
    return {
      id: r.id || `${t}|${r.title}|${r.country}`,
      datetime:t,
      title:r.title || r.event || '(No title)',
      country:r.country || r.currency || '',
      impact:['Low','Medium','High'][impactLevel-1],
      impactLevel
    };
  }).filter(e=>!Number.isNaN(new Date(e.datetime).getTime()));
}

/* ------- SEED (guarantees UI like your screenshot even if fetch fails) ------- */
const SEED = [
  { title:'ISM Manufacturing PMI', country:'USD', impact:'High', datetime:new Date().toISOString() },
  { title:'ADP Non-Farm Employment Change', country:'USD', impact:'High', datetime:new Date(Date.now()+2*60*60*1000).toISOString() },
  { title:'ISM Services PMI', country:'USD', impact:'High', datetime:new Date(Date.now()+3*60*60*1000).toISOString() },
];

/* ------- RENDER ------- */
function setHeader(){
  const now = new Date();
  document.getElementById('time').textContent = now.toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'});
  document.getElementById('upd').textContent  = 'Updated: ' + now.toLocaleString();
  // sentiment bar
  const pct = SEED_SENTIMENT; // static like your screenshot
  document.getElementById('pct').textContent = (pct>0?'+':'') + pct.toFixed(2) + '%';
  const fill = Math.max(0, Math.min(100, 50 + pct)); // center ~50, move with pct
  document.getElementById('gfill').style.width = fill + '%';
}

function renderList(events, usedSeed){
  const list = document.getElementById('list');
  list.innerHTML = '';
  const todayStart = startOfDayUTC(new Date());
  const todayEnd = new Date(todayStart.getTime() + 86400000);

  const usdHigh = events
    .filter(e => e.country === CURRENCY && e.impact === IMPACT_FILTER)
    .sort((a,b)=> new Date(a.datetime) - new Date(b.datetime));

  // Today note
  const todayCount = usdHigh.filter(e => {
    const t = new Date(e.datetime);
    return t >= todayStart && t < todayEnd;
  }).length;
  document.getElementById('todayNote').textContent =
    `Showing ${todayCount} high-impact USD events today (highlighted).` + (usedSeed ? ' (seed)' : '');

  usdHigh.forEach(ev=>{
    const t = new Date(ev.datetime);
    const card = document.createElement('div');
    card.className = 'card';
    const isToday = t >= todayStart && t < todayEnd;

    card.innerHTML = `
      <h2 class="title">${escapeHtml(ev.title)}</h2>
      <div class="badgeRow">
        <div class="badge"><span class="dim">USD</span></div>
        <div class="badge"><span class="dot"></span><span class="hi">High</span></div>
      </div>
      <div class="kv"><span class="dim">${fmtDate(t)} at ${fmtTime(t)}</span></div>
      <div class="kv"><span class="dim">Impact:</span> <span class="hi">High</span></div>
    `;
    if (isToday) card.style.outline = '2px solid rgba(239,68,68,.35)';
    list.appendChild(card);
  });

  if (usdHigh.length === 0){
    const empty = document.createElement('div');
    empty.className = 'card';
    empty.innerHTML = `<div class="dim">No high-impact USD events found in the current/next-week feed.</div>`;
    list.appendChild(empty);
  }
}

function escapeHtml(s){return s.replace(/[&<>\"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;','\'':'&#39;'}[c]));}

/* ------- LOAD ------- */
async function load(){
  setHeader();
  let usedSeed = false;
  try{
    const all = [];
    for (const u of FEEDS){
      const r = await fetch(u, { cache:'no-store' });
      if (r.ok) all.push(...await r.json());
    }
    const events = normalize(all);
    renderList(events, false);
  }catch(e){
    usedSeed = true;
    renderList(normalize(SEED), true);
  }
}
load();
</script>
</body>
</html>
