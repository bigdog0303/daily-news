export default {
  async fetch(request) {
    const url = new URL(request.url);
    const target = url.searchParams.get("url");

    // Helper to attach CORS headers to all responses
    const withCORS = (resp) => {
      const headers = new Headers(resp.headers);
      headers.set("access-control-allow-origin", "*");
      headers.set("access-control-allow-headers", "*");
      headers.set("access-control-allow-methods", "GET, OPTIONS");
      return new Response(resp.body, { ...resp, headers });
    };

    // Handle CORS preflight (for GitHub Pages requests)
    if (request.method === "OPTIONS") {
      return new Response(null, {
        headers: {
          "access-control-allow-origin": "*",
          "access-control-allow-headers": "*",
          "access-control-allow-methods": "GET, OPTIONS",
        },
      });
    }

    // ---- (1) Proxy external URL if ?url= exists ----
    if (target) {
      try {
        const resp = await fetch(target, {
          headers: { "User-Agent": "Mozilla/5.0" },
        });
        const body = await resp.text();
        return new Response(body, {
          headers: {
            "content-type": resp.headers.get("content-type") || "application/json",
            "access-control-allow-origin": "*",
          },
        });
      } catch (err) {
        return new Response(
          JSON.stringify({ error: "Proxy failed: " + err.message }),
          { status: 500, headers: { "access-control-allow-origin": "*" } }
        );
      }
    }

    // ---- (2) ForexFactory XML fetch with fallback ----
    const sources = [
      "https://cdn-nfs.faireconomy.media/ff_calendar_thisweek.xml",
      "https://cdn-nfs.faireconomy.media/ff_calendar_this.xml",
    ];

    let xml = null;
    for (const src of sources) {
      try {
        const ff = await fetch(src);
        if (ff.ok) {
          xml = await ff.text();
          break;
        }
      } catch (_) {}
    }

    if (!xml) {
      return withCORS(
        Response.json({
          ok: true,
          stale: true,
          items: [],
          warning: "ForexFactory feed unavailable",
        })
      );
    }

    // ---- (3) Parse ForexFactory ----
    const events = [...xml.matchAll(/<event>(.*?)<\/event>/gs)].map((x) => {
      const get = (tag) =>
        (x[1].match(new RegExp(`<${tag}>(.*?)<\\/${tag}>`)) || [])[1] || "";
      return {
        title: get("title"),
        datetime: get("date"),
        impact: get("impact"),
        currency: get("currency"),
        actual: get("actual"),
      };
    });
    const items = events.filter(
      (e) => e.currency === "USD" && e.impact === "High"
    );

    // ---- (4) Optional market snapshot ----
    let markets = {};
    try {
      const yurl =
        "https://query1.finance.yahoo.com/v7/finance/quote?symbols=%5EDJI,%5ENDX,%5EGSPC";
      const yresp = await fetch(yurl, {
        headers: { "User-Agent": "Mozilla/5.0" },
      });
      const ydata = await yresp.json();
      if (ydata?.quoteResponse?.result) {
        for (const q of ydata.quoteResponse.result) {
          const pct =
            ((q.regularMarketPrice - q.regularMarketPreviousClose) /
              q.regularMarketPreviousClose) *
            100;
          if (q.symbol === "^DJI")
            markets.US30 = pct.toFixed(2);
          if (q.symbol === "^NDX")
            markets.NAS100 = pct.toFixed(2);
          if (q.symbol === "^GSPC")
            markets.SPX500 = pct.toFixed(2);
        }
      }
    } catch (err) {
      markets.error = "Yahoo fetch failed: " + err.message;
    }

    // ---- (5) Final combined response ----
    const resp = Response.json({
      ok: true,
      items,
      markets,
      updated: new Date().toISOString(),
    });

    return withCORS(resp);
  },
};
