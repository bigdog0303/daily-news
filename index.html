<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<title>High-impact USD events</title>
<meta name="theme-color" content="#0c0c0e" />
<meta name="apple-mobile-web-app-capable" content="yes" />
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />

<style>
:root{
  --bg:#0c0c0e; --text:#e9e9ee; --muted:#a6a7af;
  --panel:#121316; --panel2:#17181c; --ring:#2a2b31;
  --badge:#1f2025; --accent:#ffd84a; --accent-ink:#201b07;
  --high:#c63b3b;
}
html,body{margin:0;height:100%;background:var(--bg);color:var(--text);font-family:ui-sans-serif,system-ui,-apple-system,"Segoe UI",Roboto,Arial;}
.statusbar{position:fixed;top:0;left:0;right:0;height:env(safe-area-inset-top,0);background:var(--bg);z-index:9;pointer-events:none}

header{padding:calc(8px + env(safe-area-inset-top,0)) 16px 8px;border-bottom:1px solid var(--ring)}
h1{margin:0 0 6px;font-size:32px;font-weight:800;letter-spacing:.2px}
.small{color:var(--muted);font-size:12px}

.tabs{display:flex;gap:8px;margin:8px 16px}
.tab{padding:8px 14px;border-radius:999px;border:1px solid var(--ring);background:var(--panel2);color:#d8d8dd;font-weight:600;cursor:pointer}
.tab.active{background:var(--accent-ink);border-color:var(--accent);color:#ffe899}

main{max-width:900px;margin:0 auto;padding:12px}
.note{display:flex;align-items:center;justify-content:center;min-height:52px;margin:10px 0 12px;padding:12px 14px;border-radius:14px;background:var(--panel2);border:1px solid var(--ring);color:#c9cad1;font-weight:600}
.err{color:#ff9b9b;text-align:center;margin-top:10px}

.list .item{display:flex;gap:12px;border:1px solid var(--ring);background:var(--panel2);border-radius:22px;margin:14px 0;overflow:hidden}
.item .left{width:8px;background:var(--ring)}
.item.today .left{background:var(--accent)}
.item.today{outline:1px solid rgba(255,216,74,.25)}
.item .content{flex:1;padding:16px}
.item .title{margin:0 0 10px;font-size:22px;font-weight:800}
.badges{display:flex;gap:10px;flex-wrap:wrap;margin:-2px 0 10px}
.badge{display:inline-flex;align-items:center;gap:8px;padding:6px 12px;border-radius:999px;background:var(--badge);border:1px solid var(--ring);font-size:12px;color:#d7d7dc}
.badge.high::before{content:"";width:8px;height:8px;border-radius:50%;background:var(--high)}
.when,.meta{font-size:14px;color:var(--muted)}
.footer{margin:22px 0 10px;text-align:center;color:var(--muted);font-size:12px}

/* Calendar */
#cal{display:grid;gap:10px}
.cal-head{display:grid;grid-template-columns:repeat(7,1fr);gap:6px;margin:8px 0;color:#cfd0d6;font-size:12px}
.cal-grid{display:grid;grid-template-columns:repeat(7,1fr);gap:6px}
.day{border:1px solid var(--ring);background:var(--panel2);border-radius:12px;min-height:86px;padding:8px}
.day .d{font-weight:700;font-size:12px;color:#cfd0d6}
.badge-dot{display:inline-flex;align-items:center;gap:6px;margin-top:6px;font-size:12px;color:#e9e9ee}
.badge-dot::before{content:"";width:8px;height:8px;border-radius:50%;background:var(--high)}
.is-today{outline:1px solid var(--accent);box-shadow:0 0 0 3px rgba(255,216,74,.08)}

/* TEMP: hide US30 heatbar (to avoid Yahoo 429) */
.heatmini{display:none}
</style>
</head>
<body>
<div class="statusbar" aria-hidden="true"></div>

<header>
  <div class="small" id="now"></div>
  <h1>High-impact USD events</h1>
  <div class="small" id="updated"></div>
</header>

<div class="tabs">
  <button class="tab active" id="tab-list">List</button>
  <button class="tab" id="tab-cal">Calendar</button>
</div>

<main>
  <div class="note" id="note">Loading…</div>

  <!-- list view -->
  <section id="list" class="list"></section>

  <!-- calendar view -->
  <section id="calendar" style="display:none">
    <div id="cal"></div>
  </section>

  <div class="err" id="err" hidden></div>
  <div class="footer">Data via ForexFactory (through your Worker)</div>
</main>

<template id="row">
  <div class="item">
    <div class="left"></div>
    <div class="content">
      <h3 class="title"></h3>
      <div class="badges"></div>
      <div class="when"></div>
      <div class="meta"></div>
    </div>
  </div>
</template>

<script>
// ====== CONFIG: your Cloudflare Worker URL ======
const WORKER = "https://super-voice-13a1.mikaelalexiou.workers.dev"; // change if you use a different worker

// ====== small helpers ======
const sleep = (ms)=>new Promise(r=>setTimeout(r,ms));
async function fetchWithRetry(url, tries=4){
  let last;
  for(let i=0;i<tries;i++){
    try{
      const r = await fetch(url, {cache:'no-store'});
      if(r.ok) return await r.json();
      last = new Error('HTTP '+r.status);
    }catch(e){ last = e; }
    await sleep(400*(i+1));
  }
  throw last;
}
function toDate(ts){
  if(!ts) return null;
  const d = new Date(ts);
  if(!isNaN(d)) return d;
  // try "YYYY-MM-DD HH:MM" (local)
  return new Date(ts.replace(' ', 'T'));
}

// ====== renderers ======
function renderList(items){
  const list = document.getElementById('list');
  const tpl  = document.getElementById('row');
  list.innerHTML = '';

  const todayKey = new Date().toISOString().slice(0,10);

  for(const e of items){
    const dt = toDate(e.datetime || e.date || '');
    const isToday = dt && dt.toISOString().slice(0,10) === todayKey;

    const row = tpl.content.firstElementChild.cloneNode(true);
    if(isToday) row.classList.add('today');
    row.querySelector('.title').textContent = e.title || '(no title)';

    const badges = row.querySelector('.badges');
    const b1 = document.createElement('span'); b1.className='badge'; b1.textContent='USD'; badges.appendChild(b1);
    const b2 = document.createElement('span'); b2.className='badge high'; b2.textContent='High'; badges.appendChild(b2);
    if(isToday){ const b3=document.createElement('span'); b3.className='badge'; b3.textContent='Today'; badges.appendChild(b3); }

    const fD = new Intl.DateTimeFormat([], {month:'short', day:'2-digit'});
    const fT = new Intl.DateTimeFormat([], {hour:'2-digit', minute:'2-digit'});
    row.querySelector('.when').textContent = dt ? `${fD.format(dt)} at ${fT.format(dt)}` : (e.date || '');
    row.querySelector('.meta').textContent = e.actual ? `Impact: High · ${e.actual}` : 'Impact: High';

    list.appendChild(row);
  }
}

function renderCalendar(items){
  const host = document.getElementById('cal');
  host.innerHTML = '';

  // current month
  const now = new Date(); const y = now.getFullYear(); const m = now.getMonth();
  const first = new Date(y, m, 1); const last = new Date(y, m+1, 0);
  const startDow = (first.getDay()+6)%7; // Mon=0
  const days = last.getDate();

  const head = document.createElement('div'); head.className='cal-head';
  "Mon Tue Wed Thu Fri Sat Sun".split(' ').forEach(d=>{
    const s = document.createElement('div'); s.textContent=d; head.appendChild(s);
  });
  host.appendChild(head);

  const grid = document.createElement('div'); grid.className='cal-grid';
  for(let i=0;i<startDow;i++){ const pad=document.createElement('div'); grid.appendChild(pad); }

  // index events by day
  const byDay = new Map();
  for(const e of items){
    const dt = toDate(e.datetime || e.date || '');
    if(!dt) continue;
    if(dt.getMonth()!==m || dt.getFullYear()!==y) continue;
    const key = dt.getDate();
    if(!byDay.has(key)) byDay.set(key, []);
    byDay.get(key).push(e);
  }

  const today = new Date().getDate();

  for(let d=1; d<=days; d++){
    const cell = document.createElement('div'); cell.className='day';
    if(d===today) cell.classList.add('is-today');
    const top = document.createElement('div'); top.className='d'; top.textContent=d; cell.appendChild(top);

    const events = byDay.get(d) || [];
    if(events.length){
      const dot = document.createElement('div'); dot.className='badge-dot';
      dot.textContent = `${events.length} high-impact`;
      cell.appendChild(dot);
    }
    grid.appendChild(cell);
  }
  host.appendChild(grid);
}

// ====== main ======
(async function(){
  document.getElementById('now').textContent =
    new Intl.DateTimeFormat([], {hour:'2-digit', minute:'2-digit'}).format(new Date());

  const note = document.getElementById('note');
  const err  = document.getElementById('err');

  try{
    // ask worker for ALL events; we filter here so you see data even if server filter is too strict
    const payload = await fetchWithRetry(`${WORKER}?all=1`, 4);
    let items = payload.items || [];

    // client-side filter: United States / USD + High
    items = items.filter(e=>{
      const country  = (e.country||'').toLowerCase();
      const currency = (e.currency||'').toUpperCase();
      const impact   = (e.impact||'').toLowerCase();
      const isUSCountry = country.includes('united states') || country==='us' || country==='u.s.' || country.startsWith('us ');
      const isUSCurrency = currency==='USD';
      const isHigh = impact.includes('high');
      return (isUSCountry || isUSCurrency) && isHigh;
    });

    // sort
    items.sort((a,b)=> (Date.parse(a.datetime||'')||0) - (Date.parse(b.datetime||'')||0));

    renderList(items);
    renderCalendar(items);

    note.textContent = `Loaded ${items.length} USD high-impact events.`;
    document.getElementById('updated').textContent = 'Updated: ' + new Date().toLocaleString();
    err.hidden = true;
  }catch(e){
    note.textContent = '';
    err.hidden = false;
    err.textContent = 'Could not load from proxy: ' + (e.message || e);
    console.error(e);
  }

  // tabs
  const tList = document.getElementById('tab-list');
  const tCal  = document.getElementById('tab-cal');
  const vList = document.getElementById('list');
  const vCal  = document.getElementById('calendar');

  tList.onclick = ()=>{ tList.classList.add('active'); tCal.classList.remove('active'); vList.style.display=''; vCal.style.display='none'; };
  tCal.onclick  = ()=>{ tCal.classList.add('active'); tList.classList.remove('active'); vCal.style.display=''; vList.style.display='none'; };
})();
</script>
</body>
</html>
