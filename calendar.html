<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>FX Calendar — Standalone</title>
  <style>
    :root{--bg:#0b0f14;--card:#121821;--text:#e6edf3;--muted:#9fb0c3;--brand:#22d3ee;--hi:#f87171;--med:#60a5fa;--low:#4ade80}
    *{box-sizing:border-box} body{margin:0;background:var(--bg);color:var(--text);font:14px/1.45 system-ui,Segoe UI,Roboto}
    header{position:sticky;top:0;background:linear-gradient(180deg,#0b0f14 0%, rgba(11,15,20,0.8) 100%);backdrop-filter: blur(6px);z-index:10}
    .wrap{max-width:1200px;margin:0 auto;padding:20px}
    h1{margin:0;font-size:22px;font-weight:700}
    .toolbar{display:flex;gap:10px;align-items:center;margin-top:10px}
    button{background:var(--card);color:var(--text);border:1px solid #1f2937;border-radius:10px;padding:8px 12px;cursor:pointer}
    .grid{display:grid;grid-template-columns:repeat(7,1fr);gap:10px;margin-top:16px}
    .cell{background:var(--card);border:1px solid #1f2937;border-radius:12px;padding:10px;min-height:120px;display:flex;flex-direction:column}
    .date{font-weight:700;color:var(--muted);font-size:12px}
    .ev{margin-top:6px;padding:6px 8px;border-radius:10px;font-size:12px}
    .hi{background:rgba(248,113,113,.12);color:var(--hi)}
    .med{background:rgba(96,165,250,.12);color:var(--med)}
    .low{background:rgba(74,222,128,.12);color:var(--low)}
    .empty{opacity:.4}
    .note{color:var(--muted);font-size:12px;margin-top:8px}
    .err{color:#fda4af;font-size:12px;margin-top:8px}
  </style>
</head>
<body>
  <header>
    <div class="wrap">
      <h1>Monthly FX Calendar</h1>
      <div class="toolbar">
        <button id="prev">◀ Prev</button>
        <div id="label" style="font-weight:700"></div>
        <button id="next">Next ▶</button>
        <input id="kw" placeholder="Search keyword (e.g., CPI, NFP)" style="margin-left:auto;padding:8px 10px;border-radius:10px;border:1px solid #1f2937;background:var(--card);color:var(--text)" />
        <button id="go">Search</button>
      </div>
      <div class="note">Note: Standalone mode shows data for the current & next week (ForexFactory provides those JSON feeds). Days outside those weeks may appear empty.</div>
      <div id="err" class="err"></div>
    </div>
  </header>
  <main class="wrap">
    <div id="cal" class="grid"></div>
  </main>

  <script>
    const SRC = [
      'https://cdn-nfs.faireconomy.media/ff_calendar_thisweek.json',
      'https://cdn-nfs.faireconomy.media/ff_calendar_nextweek.json'
    ];
    let cur = new Date();

    document.getElementById('prev').onclick = ()=>{ cur.setMonth(cur.getMonth()-1); render(); };
    document.getElementById('next').onclick = ()=>{ cur.setMonth(cur.getMonth()+1); render(); };
    document.getElementById('go').onclick = search;

    async function fetchTwoWeeks(){
      const out = [];
      for (const u of SRC){
        try{
          const r = await fetch(u, { cache: 'no-store' });
          if (r.ok) out.push(...(await r.json()));
        }catch(e){}
      }
      return out;
    }

    function inferISO(r){
      let ms=null;
      if (typeof r.timestamp==='number') ms=r.timestamp*(r.timestamp<2e10?1000:1);
      else if (typeof r.unix==='number') ms=r.unix*(r.unix<2e10?1000:1);
      if (ms) return new Date(ms).toISOString();
      const d=(r.date||r.day||r.datetime||'').toString();
      const time=(r.time||r.hour||'00:00').toString();
      const iso=new Date(`${d} ${time} UTC`);
      return !Number.isNaN(iso.getTime())?iso.toISOString():new Date().toISOString();
    }

    function normalize(raw){
      return (raw||[]).map(r=>{
        const t=inferISO(r);
        const impactRaw=(r.impact||r.impact_text||r.impact_label||'').toString().toLowerCase();
        const impactLevel=/high|red|3/.test(impactRaw)?3:/medium|yellow|2/.test(impactRaw)?2:1;
        return {
          id: r.id || `${t}|${r.title}|${r.country}`,
          datetime: t,
          title: r.title || r.event || '(No title)',
          country: r.country || r.currency || '',
          impact: ['Low','Medium','High'][impactLevel-1],
          impactLevel
        };
      }).filter(e=>!Number.isNaN(new Date(e.datetime).getTime()));
    }

    async function search(){
      const kw = document.getElementById('kw').value.trim().toLowerCase();
      if (!kw) return render();
      const events = normalize(await fetchTwoWeeks());
      const hits = events.filter(e =>
        e.title.toLowerCase().includes(kw) || e.country.toLowerCase().includes(kw)
      );
      alert(`Found ${hits.length} events containing "${kw}" in current/next week feeds.`);
    }

    async function render(){
      document.getElementById('err').textContent = '';
      const y = cur.getFullYear();
      const m = cur.getMonth()+1;
      document.getElementById('label').textContent = cur.toLocaleString(undefined,{month:'long',year:'numeric'});

      const grid = document.getElementById('cal');
      grid.innerHTML = '';

      // headers
      ['Mon','Tue','Wed','Thu','Fri','Sat','Sun'].forEach(h=>{
        const el=document.createElement('div');
        el.className='cell empty';
        el.innerHTML=`<div class="date" style="font-weight:800">${h}</div>`;
        grid.appendChild(el);
      });

      // calculate month layout
      const first = new Date(Date.UTC(y, m-1, 1));
      const startCol = (first.getUTCDay() + 6) % 7; // Monday=0
      const daysInMonth = new Date(Date.UTC(y, m, 0)).getUTCDate();
      for (let i=0;i<startCol;i++){
        const el=document.createElement('div'); el.className='cell empty'; grid.appendChild(el);
      }

      try{
        const events = normalize(await fetchTwoWeeks());
        const byDay = {};
        for (const ev of events){
          const d = new Date(ev.datetime);
          if (d.getUTCFullYear()===y && (d.getUTCMonth()+1)===m){
            const key = d.toISOString().slice(0,10);
            (byDay[key] ||= []).push(ev);
          }
        }

        for (let d=1; d<=daysInMonth; d++){
          const iso = new Date(Date.UTC(y, m-1, d)).toISOString().slice(0,10);
          const evs = (byDay[iso] || []).sort((a,b)=> new Date(a.datetime)-new Date(b.datetime));
          const el = document.createElement('div');
          el.className='cell';
          el.innerHTML = `<div class="date">${d}</div>`;
          for (const ev of evs){
            const t = new Date(ev.datetime).toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'});
            const cls = ev.impact==='High'?'hi':ev.impact==='Medium'?'med':'low';
            const div = document.createElement('div');
            div.className = `ev ${cls}`;
            div.textContent = `${t} • ${ev.country} — ${ev.title}`;
            el.appendChild(div);
          }
          grid.appendChild(el);
        }
      }catch(e){
        document.getElementById('err').textContent = 'Could not load data.';
      }
    }

    render();
  </script>
</body>
</html>
